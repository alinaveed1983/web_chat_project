{% extends "base.html" %}

{% block title %}{{ room_name }}{% endblock %}

{% block content %}
<h2>{{ room_name }}</h2>

<!-- Section for displaying users in the room -->
<h3>Users in this Room</h3>
<ul id="user-list">
    <!-- Placeholder if the user list is empty -->
    <li id="no-users" style="display: none;">No users in this room.</li>
</ul>

<!-- Section for displaying chat messages -->
<h3>Messages</h3>
<ul id="messages">
    <!-- Placeholder if there are no messages -->
    <li id="no-messages" style="display: none;">No messages yet.</li>
</ul>

<!-- Input field for sending messages -->
<input type="text" id="messageInput" placeholder="Type a message...">
<button onclick="sendMessage()">Send</button>

<!-- Leave Room Button -->
<button onclick="leaveRoom()">Leave Room</button>

<script>
    // Room name for WebSocket connection
    const roomName = "{{ room_name }}";
    const chatSocket = new WebSocket(
        'ws://' + window.location.host + '/ws/chat/' + roomName + '/'
    );

    // Handle incoming WebSocket messages
chatSocket.onmessage = function(e) {
    const data = JSON.parse(e.data);

    // Handle chat messages
    if (data.type === 'message') {
        const messageHTML = `<li><strong>${data.username}:</strong> ${data.message}</li>`;
        document.querySelector('#messages').innerHTML += messageHTML;

        // Hide the "No messages" placeholder if a message is added
        document.querySelector('#no-messages').style.display = 'none';
    }

    // Handle updates to the user list
    if (data.type === 'user_list') {
        const userListElement = document.querySelector('#user-list');
        userListElement.innerHTML = ''; // Clear current user list
        if (data.users.length === 0) {
            // Show placeholder if no users are present
            document.querySelector('#no-users').style.display = 'block';
        } else {
            data.users.forEach(function(user) {
                const userElement = `<li>${user}</li>`;
                userListElement.innerHTML += userElement;
            });
            document.querySelector('#no-users').style.display = 'none'; // Hide placeholder
        }
    }
};


    // Handle WebSocket closure
    chatSocket.onclose = function(e) {
        console.error('WebSocket closed unexpectedly');
    };

    // Function to send messages to the WebSocket server
    function sendMessage() {
        const input = document.querySelector('#messageInput');
        const message = input.value;
        if (message) {
            chatSocket.send(JSON.stringify({ 'message': message }));
            input.value = ''; // Clear the input field after sending
        }
    }

    // Leave Room Logic
    function leaveRoom() {
        window.location.href = '/'; // Redirect to Available Chat Rooms page
    }

    // Fetch chat history on page load
    document.addEventListener('DOMContentLoaded', function() {
        fetch(`/history/${roomName}/`)
            .then(response => {
                if (!response.ok) {
                    throw new Error("Error loading chat history.");
                }
                return response.json();
            })
            .then(data => {
                const messagesElement = document.querySelector('#messages');
                if (data.messages.length > 0) {
                    data.messages.forEach(function(msg) {
                        const messageHTML = `<li><strong>${msg.username}:</strong> ${msg.message} <em>(${msg.timestamp})</em></li>`;
                        messagesElement.innerHTML += messageHTML;
                    });
                    document.querySelector('#no-messages').style.display = 'none';
                }
            })
            .catch(error => {
                console.error("Error Fetching Chat History:", error);
                const messagesElement = document.querySelector('#messages');
                messagesElement.innerHTML = `<li style="color: red;">${error.message}</li>`;
            });
    });
</script>
{% endblock %}
